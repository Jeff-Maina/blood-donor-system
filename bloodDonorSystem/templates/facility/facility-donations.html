{% extends "facility/layout.html" %}

{% block title %} Blood Donor System | Donations {% endblock %}


{% block content %}

<div class="w-full p-4 flex flex-col gap-4">
    <div class="w-full grid grid-cols-3 gap-4">
        <div class="w-full h-36 rounded-md shadow p-6 border">
            <div class="flex flex-col gap-4">
                <p class="font-medium">Total Donations</p>
                <p class="text-3xl font-semibold tracking-tight">{{ total_donations }}</p>
            </div>
        </div>
        <div class="w-full h-36 rounded-md shadow p-6 border">
            <div class="flex flex-col gap-4">
                <p class="font-medium">Completed donations</p>
                <p class="text-3xl font-semibold tracking-tight">{{ completed_donations_count }}</p>
            </div>
        </div>
        <div class="w-full h-36 rounded-md shadow p-6 border">
            <div class="flex flex-col gap-4">
                <p class="font-medium">Total Blood Donated</p>
                <p class="text-3xl font-semibold tracking-tight">{{ total_blood_donated }} Litres</p>
            </div>
        </div>


    </div>

    <div class="w-full col-span-2 rounded-md shadow p-6 border flex flex-col gap-4 ">
        <h1 class="font-semibold">Requests</h1>
        <div class="w-full">
            <table class="w-full">
                <thead>
                    <tr class="">
                        <th class="p-2 text-left font-semibold">Individual</th>
                        <th class="p-2 text-left font-semibold">Email</th>
                        <th class="p-2 text-left font-semibold">Phone</th>
                        <th class="p-2 text-left font-semibold">Blood Type</th>
                        <th class="p-2 text-left font-semibold">Type</th>
                        <th class="p-2 text-left font-semibold">Amount</th>
                        <th class="p-2 text-left font-semibold">Progress</th>
                        <th class="p-2 text-left font-semibold">Approval Status</th>
                        <th class="p-2 text-left font-semibold">Donation Date/Time</th>
                        <th class="p-2 text-left font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for donation in donations %}
                    <tr>
                        <td class="p-2  truncate text-neutral-800">{{ donation.user.firstname }}
                            {{donation.user.lastname}}</td>
                        <td class="p-2  truncate text-neutral-800">{{ donation.user.user.email }}</td>
                        <td class="p-2  truncate text-neutral-800">{{ donation.user.phone }}</td>
                        <td class="p-2  truncate text-neutral-800">{{ donation.user.blood_group }}</td>
                        <td class="p-2  truncate text-neutral-800 capitalize">{{ donation.donation_type }}</td>
                        <td class="p-2  truncate text-neutral-800">{{ donation.amount }} ml</td>
                        <td class="p-2  truncate text-neutral-800">{{ donation.status }}</td>
                        <td class="p-2  truncate text-neutral-800">
                            {% if donation.approval_status == 'pending' %}
                            <div class="text-purple-600 flex items-center  gap-2 font-medium">
                                <i data-lucide="clock" class=" size-4" stroke-width="3"></i>
                                <span>Pending</span>
                            </div>
                            {% elif donation.approval_status == 'approved' %}
                            <div class="text-green-600 flex items-center  gap-2 font-medium">
                                <i data-lucide="circle-check" class="size-4" stroke-width="3"></i>
                                <span>Approved</span>
                            </div>
                            {% elif donation.approval_status == 'rejected' %}
                            <div class="text-red-600 flex items-center  gap-2 font-medium">
                                <i data-lucide="circle-x" class=" size-4" stroke-width="3"></i>
                                <span>Rejected</span>
                            </div>
                            {% endif %}
                        </td>
                        <td class="p-2  truncate text-neutral-800 capitalize">{{ donation.donation_date|date:'Y-m-d, g:i a' }}
                        </td>
                        <td class=" w-16 flex items-center justify-center h-10">

                            <div class="relative">
                                <button data-id="{{ donation.id }}"
                                    class="size-8 actions-btn group/button relative  aspect-square rounded  hover:bg-neutral-100 text-neutral-600 flex items-center justify-center   p-2 ">
                                    <i data-lucide="ellipsis" class="size-5" stroke-width="3"></i>
                                </button>

                                <div data-id="{{ donation.id }}" id="actionsMenuBackdrop{{ donation.id }}"
                                    class="fixed hidden backdrop top-0 left-0 w-full h-full bg-transparent"></div>
                                <div id="actionsMenu{{ donation.id }}"
                                    class="absolute p-1.5 z-20 hidden bottom-full border right-full w-[190px] text-sm  min-w-fit rounded-md bg-white shadow-md">
                                    <a href="{% url 'approve-donation' donation.id %}">
                                        <button
                                            class="flex rounded-md font-medium items-center gap-2 px-2 py-1 hover:bg-neutral-100 text-neutral-700 hover:text-black">
                                            <i data-lucide="check" class="shrink-0 size-4"></i>
                                            Approve donation
                                        </button>
                                    </a>
                                    <a href="{% url 'reject-donation' donation.id %}">
                                        <button
                                            class="flex rounded-md font-medium items-center gap-2 px-2 py-1 hover:bg-neutral-100 text-neutral-700 hover:text-black">
                                            <i data-lucide="x" class="size-4 shrink-0"></i>
                                            Reject donation
                                        </button>
                                    </a>
                                    <a href="{% url 'mark_donation_complete' donation.id %}">
                                        <button
                                            class="flex rounded-md font-medium items-center gap-2 px-2 py-1 hover:bg-neutral-100 text-neutral-700 hover:text-black">
                                            <i data-lucide="circle-check" class="shrink-0 size-4"></i>

                                            Mark as complete
                                        </button>
                                    </a>
                                </div>
                            </div>

                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const action_buttons = document.querySelectorAll(".actions-btn")
        action_buttons.forEach((button) => {
            button.addEventListener("click", (e) => {
                e.preventDefault()
                const menu = document.querySelector(`#actionsMenu${button.dataset.id}`)
                const backdrop = document.querySelector(`#actionsMenuBackdrop${button.dataset.id}`)
                menu.classList.remove("hidden")
                backdrop.classList.remove("hidden")
            })
        })

        const backdrops = document.querySelectorAll(".backdrop")

        backdrops.forEach((backdrop) => {
            backdrop.addEventListener("click", (e) => {
                console.log("clicked")
                e.preventDefault()
                const menu = document.querySelector(`#actionsMenu${backdrop.dataset.id}`)
                menu.classList.add("hidden")
                backdrop.classList.add("hidden")
            })
        })


    }
    )
</script>


{% endblock %}